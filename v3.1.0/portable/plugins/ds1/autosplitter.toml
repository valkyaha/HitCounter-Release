# =============================================================================
# AUTOSPLITTER CONFIGURATION
# =============================================================================

[autosplitter]
enabled = true
algorithm = "offset_table"

# Offset table algorithm configuration (DS1 style)
# Based on SoulSplitter by FrankvdStam
[autosplitter.offset_table_config]
primary_pattern = "event_flags"

# Group offsets (from SoulSplitter)
[autosplitter.offset_table_config.group_offsets]
"0" = 0
"1" = 1280       # 0x00500
"5" = 24320      # 0x05F00
"6" = 47360      # 0x0B900
"7" = 70400      # 0x11300

# Area indices (from SoulSplitter)
[autosplitter.offset_table_config.area_indices]
"000" = 0
"100" = 1
"101" = 2
"102" = 3
"110" = 4
"120" = 5
"121" = 6
"130" = 7
"131" = 8
"132" = 9
"140" = 10
"141" = 11
"150" = 12
"151" = 13
"160" = 14
"170" = 15
"180" = 16
"181" = 17
"200" = 18
"210" = 19

# Memory patterns for finding game data structures
# Based on SoulSplitter by FrankvdStam
# https://github.com/FrankvdStam/SoulSplitter

[[autosplitter.patterns]]
name = "event_flags"
pattern = "48 8B 0D ? ? ? ? 99 33 C2 45 33 C0 2B C2 8D 50 F6"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0, 0, 0]  # Two dereferences needed

[[autosplitter.patterns]]
name = "game_data_man"
pattern = "48 8B 05 ? ? ? ? 48 8B 50 10 48 89 54 24 60"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "game_man"
pattern = "48 8B 05 ? ? ? ? C6 40 18 00"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "world_chr_man"
pattern = "48 8B 0D ? ? ? ? 0F 28 F1 48 85 C9 74 ? 48 89 7C"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "menu_man"
pattern = "48 8B 15 ? ? ? ? 89 82 7C 08 00 00"
rip_offset = 3
instruction_len = 7
pointer_offsets = [0]

[[autosplitter.patterns]]
name = "bonfire_db"
pattern = "48 83 3D ? ? ? ? 00 48 8B F1"
rip_offset = 3
instruction_len = 8  # Different from others - 8 byte instruction
pointer_offsets = [0]

# =============================================================================
# POINTER CHAINS - Derived pointers from base patterns
# =============================================================================

[autosplitter.pointers]
# Player data from GameDataMan
player_game_data = { base = "game_data_man", offsets = [0, 0x10] }

# Player instance from WorldChrMan
player_ins = { base = "world_chr_man", offsets = [0, 0x68] }  # 0x68 default, 0x48 for v1.0.1
player_pos = { base = "world_chr_man", offsets = [0, 0x68, 0x28] }

# =============================================================================
# MEMORY LAYOUT - Offsets for reading values
# =============================================================================

[autosplitter.memory_layout]
# In-game time at GameDataMan + 0xA4
igt_offset = 0xA4

# NG+ count at GameDataMan + 0x78
ng_count_offset = 0x78

# Current save slot at GameDataMan + offset (version dependent)
current_save_slot_offset = 0xAA0  # 0xA90 for v1.0.1

# Warp requested check at GameMan + 0x19
warp_requested_offset = 0x19

# Credits check offsets from MenuMan
credits_offset_80 = 0x80
credits_offset_c8 = 0xC8
credits_offset_d4 = 0xD4

# Player health at PlayerIns + 0x3E8
player_health_offset = 0x3E8

# Position offsets from PlayerPos
position_x = 0x10
position_y = 0x14
position_z = 0x18

# Attribute offsets from PlayerGameData + 0x8
[autosplitter.memory_layout.attributes]
vitality = 0x0
attunement = 0x4
endurance = 0x8
strength = 0xC
dexterity = 0x10
resistance = 0x14
intelligence = 0x18
faith = 0x1C
humanity = 0x24
soul_level = 0x28

# =============================================================================
# VERSION VARIANTS - Game version specific offsets
# =============================================================================

[[autosplitter.versions]]
version = "default"
description = "Dark Souls Remastered (latest)"
player_ctrl_offset = 0x68
current_save_slot_offset = 0xAA0

[[autosplitter.versions]]
version = "v1.0.1"
description = "Dark Souls Remastered v1.0.1"
player_ctrl_offset = 0x48
current_save_slot_offset = 0xA90

# =============================================================================
# EVENT FLAG CALCULATION CONSTANTS
# =============================================================================

[autosplitter.event_flag_config]
# These are used to calculate the memory offset for a given flag ID
# Offset = group_offset + (area_index * 0x500) + (section * 128) + ((number - (number % 32)) / 8)
# Mask = 0x80000000 >> (number % 32)
area_multiplier = 0x500
section_multiplier = 128

# =============================================================================
# LIVESPLIT-STYLE SCRIPT CONFIGURATION
# =============================================================================

[script]
version = "1.0"
name = "Dark Souls Remastered Script"
description = "LiveSplit-style autosplitter script for Dark Souls Remastered"

[script.state.eventFlags]
type = "ptr"
pattern = "48 8B 0D ?? ?? ?? ?? 99 33 C2 45 33 C0 2B C2 8D 50 F6"
pattern_offset = 3
pattern_length = 7

[script.state.inGame]
type = "bool"
base_watcher = "eventFlags"
offsets = [0x0]

[script.hooks]
start = "settings.autostart && current.inGame && !old.inGame"
reset = "settings.autoreset && !current.inGame && old.inGame"
split = "settings.splitOnDeath && current.playerHP == 0 && old.playerHP > 0"

[script.settings]
autostart = { default = true, label = "Auto-start timer", description = "Start timer when entering a new game" }
autoreset = { default = false, label = "Auto-reset on menu", description = "Reset timer when returning to main menu" }
splitOnDeath = { default = false, label = "Split on death", description = "Trigger split when player dies" }
